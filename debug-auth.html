<!DOCTYPE html>
<html>
<head>
    <title>Cognito Authentication Debug</title>
</head>
<body>
    <h1>Cognito Authentication Debug</h1>

    <div>
        <h2>Test 1: Direct Cognito (No Azure AD)</h2>
        <button onclick="testDirectCognito()">Test Direct Cognito</button>
    </div>

    <div>
        <h2>Test 2: Cognito with Azure AD</h2>
        <button onclick="testCognitoWithAzureAD()">Test Cognito + Azure AD</button>
    </div>

    <div>
        <h2>Current Configuration</h2>
        <pre id="config"></pre>
    </div>

    <div>
        <h2>Debug Output</h2>
        <pre id="debug"></pre>
    </div>

    <script>
        const config = {
            cognitoDomain: 'varekatalog-auth-dev.auth.eu-west-1.amazoncognito.com',
            clientId: '58hle80tfmljv7rbmf9o4tfmsf',
            redirectUri: window.location.origin + '/auth/callback',
            scopes: ['openid', 'profile', 'email', 'varekatalog/search', 'varekatalog/prices', 'varekatalog/inventory']
        };

        document.getElementById('config').textContent = JSON.stringify(config, null, 2);

        function log(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.textContent += new Date().toISOString() + ': ' + message + '\n';
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, Array.from(array)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, Array.from(new Uint8Array(digest))))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function generateState() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, Array.from(array)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function testDirectCognito() {
            log('Starting Direct Cognito Test...');

            const codeVerifier = generateCodeVerifier();
            const state = generateState();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);

            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: config.clientId,
                redirect_uri: config.redirectUri,
                scope: config.scopes.join(' '),
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
                // NO identity_provider parameter
            });

            const authUrl = `https://${config.cognitoDomain}/oauth2/authorize?${authParams.toString()}`;

            log('Direct Cognito Auth URL: ' + authUrl);
            log('Redirecting...');

            window.location.href = authUrl;
        }

        async function testCognitoWithAzureAD() {
            log('Starting Cognito + Azure AD Test...');

            const codeVerifier = generateCodeVerifier();
            const state = generateState();
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);

            const authParams = new URLSearchParams({
                response_type: 'code',
                client_id: config.clientId,
                redirect_uri: config.redirectUri,
                scope: config.scopes.join(' '),
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256',
                identity_provider: 'AzureAD'
            });

            const authUrl = `https://${config.cognitoDomain}/oauth2/authorize?${authParams.toString()}`;

            log('Azure AD Auth URL: ' + authUrl);
            log('Redirecting...');

            window.location.href = authUrl;
        }
    </script>
</body>
</html>